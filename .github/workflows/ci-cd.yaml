name: AI Server CI/CD

on:
  push:
    branches:
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main

concurrency:
  group: ai-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-source-branch:
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Validate source branch
        run: |
          if [ "${{ github.head_ref }}" != "develop" ] && [[ "${{ github.head_ref }}" != hotfix/* ]]; then
            echo "âŒ Error: Only 'develop' or 'hotfix/*' branches can be merged into 'main'"
            echo "Source branch: ${{ github.head_ref }}"
            exit 1
          fi
          echo "âœ… Source branch validation passed: ${{ github.head_ref }}"

  #  ci:
  #    needs: [check-source-branch]
  #    if: always() && (needs.check-source-branch.result == 'success' || needs.check-source-branch.result == 'skipped')
  #    runs-on: ubuntu-latest
  #    steps:
  #      - name: Checkout code
  #        uses: actions/checkout@v4
  #
  #      - name: Set up Python 3.10
  #        uses: actions/setup-python@v5
  #        with:
  #          python-version: "3.10"
  #          cache: "pip"
  #
  #      - name: Install dependencies
  #        run: |
  #          python -m pip install --upgrade pip
  #
  #          if [ -f "requirements-torch.txt" ]; then
  #            pip install -r requirements-torch.txt --index-url https://download.pytorch.org/whl/cpu
  #          fi
  #
  #          pip install -r requirements.txt
  #          pip install ruff pytest
  #
  #      - name: Lint with Ruff
  #        continue-on-error: true
  #        run: ruff check . --output-format=github
  #
  #      - name: Format check with Ruff
  #        continue-on-error: true
  #        run: ruff format --check .
  #
  #      - name: Run tests
  #        continue-on-error: true
  #        run: |
  #          pytest --tb=short -q || echo "::warning::Tests failed or no tests found"
  #
  #      - name: Notify Discord on failure
  #        if: failure()
  #        run: |
  #          COMMIT_SHA="${{ github.sha }}"
  #          SHORT_SHA="${COMMIT_SHA:0:7}"
  #          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
  #          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
  #          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
  #          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
  #
  #          curl -H "Content-Type: application/json" \
  #               -X POST \
  #               -d "{
  #                 \"content\": \"âŒ **AI Server CI ë¹Œë“œ ì‹¤íŒ¨**\",
  #                 \"embeds\": [{
  #                   \"title\": \"ğŸ”´ ë¹Œë“œ ì‹¤íŒ¨ ì•Œë¦¼\",
  #                   \"color\": 15158528,
  #                   \"fields\": [
  #                     {\"name\": \"ğŸ“¦ ì €ì¥ì†Œ\", \"value\": \"\`${{ github.repository }}\`\", \"inline\": true},
  #                     {\"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
  #                     {\"name\": \"ğŸ”– ì»¤ë°‹\", \"value\": \"[\`$SHORT_SHA\`]($COMMIT_URL)\", \"inline\": true},
  #                     {\"name\": \"ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": \"$COMMIT_MSG\", \"inline\": false},
  #                     {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"$COMMIT_AUTHOR\", \"inline\": true},
  #                     {\"name\": \"ğŸ“‹ ìƒì„¸ ë¡œê·¸\", \"value\": \"[Actionsì—ì„œ í™•ì¸]($ACTIONS_URL)\", \"inline\": true}
  #                   ],
  #                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
  #                 }]
  #               }" \
  #               ${{ secrets.DISCORD_WEBHOOK_URL }} || true

  build-and-push:
    #    needs: ci
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      image-tag: ${{ steps.meta.outputs.image-tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image metadata
        id: meta
        run: |
          REGISTRY="${{ secrets.ECR_REGISTRY }}"
          if [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            TAG="develop"
            echo "tags=${REGISTRY}/doktori/ai:develop" >> $GITHUB_OUTPUT
          else
            SHORT_SHA="${GITHUB_SHA:0:7}"
            TAG="sha-${SHORT_SHA}"
            {
              echo "tags<<EOF"
              echo "${REGISTRY}/doktori/ai:sha-${SHORT_SHA}"
              echo "${REGISTRY}/doktori/ai:latest"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi
          echo "image-tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push AI image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha,scope=ai
          cache-to: type=gha,mode=max,scope=ai

  deploy-dev:
    needs: build-and-push
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Deploy to Dev via SSM
        run: |
          COMMANDS=$(jq -n --arg registry "${{ secrets.ECR_REGISTRY }}" '[
            "set -e",
            ("aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin " + $registry),
            ("docker pull " + $registry + "/doktori/ai:develop"),
            "docker stop ai 2>/dev/null || true",
            "docker rm ai 2>/dev/null || true",
            ("docker run -d --name ai --restart unless-stopped --env-file /home/ubuntu/app/ai/.env -p 8000:8000 " + $registry + "/doktori/ai:develop"),
            "docker image prune -f"
          ]')

          CMD_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Environment,Values=dev" "Key=tag:Service,Values=ai" \
            --parameters "{\"commands\": $COMMANDS}" \
            --timeout-seconds 300 \
            --comment "deploy dev ai ${{ github.sha }}" \
            --query "Command.CommandId" \
            --output text)

          echo "SSM Command: $CMD_ID"

          for i in $(seq 1 60); do
            sleep 5
            STATUS=$(aws ssm list-command-invocations \
              --command-id "$CMD_ID" \
              --query "CommandInvocations[0].Status" \
              --output text 2>/dev/null || echo "Pending")
            echo "[$i/60] $STATUS"
            case "$STATUS" in
              Success) exit 0 ;;
              Failed|Cancelled|TimedOut|DeliveryTimedOut)
                aws ssm list-command-invocations --command-id "$CMD_ID" --details \
                  --query "CommandInvocations[0].CommandPlugins[0].Output" --output text || true
                exit 1 ;;
            esac
          done
          echo "::error::SSM command timed out"
          exit 1

      - name: Notify Discord
        if: always()
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "${{ job.status }}" == "success" ]; then
            COLOR=3066993; STATUS_EMOJI="âœ…"; STATUS_TEXT="ë°°í¬ ì„±ê³µ"
          else
            COLOR=15158528; STATUS_EMOJI="âŒ"; STATUS_TEXT="ë°°í¬ ì‹¤íŒ¨"
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"$STATUS_EMOJI **AI Server Development ë°°í¬ ì•Œë¦¼**\",
                 \"embeds\": [{
                   \"title\": \"ğŸ”§ [Development] $STATUS_TEXT\",
                   \"color\": $COLOR,
                   \"fields\": [
                     {\"name\": \"ğŸ“¦ ì €ì¥ì†Œ\", \"value\": \"\`${{ github.repository }}\`\", \"inline\": true},
                     {\"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                     {\"name\": \"ğŸ”– ì»¤ë°‹\", \"value\": \"[\`$SHORT_SHA\`]($COMMIT_URL)\", \"inline\": true},
                     {\"name\": \"ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": \"$COMMIT_MSG\", \"inline\": false},
                     {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"$COMMIT_AUTHOR\", \"inline\": true},
                     {\"name\": \"ğŸ“‹ ìƒì„¸ ë¡œê·¸\", \"value\": \"[Actionsì—ì„œ í™•ì¸]($ACTIONS_URL)\", \"inline\": true}
                   ],
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }} || true

  deploy-prod:
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Deploy to Prod via SSM
        run: |
          REGISTRY="${{ secrets.ECR_REGISTRY }}"
          TAG="${{ needs.build-and-push.outputs.image-tag }}"

          COMMANDS=$(jq -n --arg registry "$REGISTRY" --arg tag "$TAG" '[
            "set -e",
            ("aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin " + $registry),
            ("docker pull " + $registry + "/doktori/ai:" + $tag),
            "docker stop ai 2>/dev/null || true",
            "docker rm ai 2>/dev/null || true",
            ("docker run -d --name ai --restart unless-stopped --env-file /home/ubuntu/app/ai/.env -p 8000:8000 " + $registry + "/doktori/ai:" + $tag),
            "docker image prune -f"
          ]')

          CMD_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Environment,Values=prod" "Key=tag:Service,Values=ai" \
            --parameters "{\"commands\": $COMMANDS}" \
            --timeout-seconds 300 \
            --comment "deploy prod ai ${{ github.sha }}" \
            --query "Command.CommandId" \
            --output text)

          echo "SSM Command: $CMD_ID"

          for i in $(seq 1 60); do
            sleep 5
            STATUS=$(aws ssm list-command-invocations \
              --command-id "$CMD_ID" \
              --query "CommandInvocations[0].Status" \
              --output text 2>/dev/null || echo "Pending")
            echo "[$i/60] $STATUS"
            case "$STATUS" in
              Success) exit 0 ;;
              Failed|Cancelled|TimedOut|DeliveryTimedOut)
                aws ssm list-command-invocations --command-id "$CMD_ID" --details \
                  --query "CommandInvocations[0].CommandPlugins[0].Output" --output text || true
                exit 1 ;;
            esac
          done
          echo "::error::SSM command timed out"
          exit 1

      - name: Notify Discord
        if: always()
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "${{ job.status }}" == "success" ]; then
            COLOR=3066993; STATUS_EMOJI="âœ…"; STATUS_TEXT="ë°°í¬ ì„±ê³µ"
          else
            COLOR=15158528; STATUS_EMOJI="âŒ"; STATUS_TEXT="ë°°í¬ ì‹¤íŒ¨"
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"$STATUS_EMOJI **AI Server Production ë°°í¬ ì•Œë¦¼**\",
                 \"embeds\": [{
                   \"title\": \"ğŸš€ [Production] $STATUS_TEXT\",
                   \"color\": $COLOR,
                   \"fields\": [
                     {\"name\": \"ğŸ“¦ ì €ì¥ì†Œ\", \"value\": \"\`${{ github.repository }}\`\", \"inline\": true},
                     {\"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                     {\"name\": \"ğŸ”– ì»¤ë°‹\", \"value\": \"[\`$SHORT_SHA\`]($COMMIT_URL)\", \"inline\": true},
                     {\"name\": \"ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": \"$COMMIT_MSG\", \"inline\": false},
                     {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"$COMMIT_AUTHOR\", \"inline\": true},
                     {\"name\": \"ğŸ“‹ ìƒì„¸ ë¡œê·¸\", \"value\": \"[Actionsì—ì„œ í™•ì¸]($ACTIONS_URL)\", \"inline\": true}
                   ],
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }} || true
