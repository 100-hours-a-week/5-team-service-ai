name: AI TEST ECR Deploy

on:
  # push:
  workflow_dispatch:

concurrency:
  group: ai-test-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: ai-test
  CONTAINER_NAME: ai-test
  PORT: "8000"

jobs:
  # (선택) 빠른 검증: ruff/pytest 등
  # 처음엔 배포 성공이 우선이면 이 job 통째로 주석 처리해도 됨
  ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff pytest

      - name: Ruff lint
        continue-on-error: true
        run: ruff check . --output-format=github

      - name: Ruff format check
        continue-on-error: true
        run: ruff format --check .

      - name: Pytest
        continue-on-error: true
        run: pytest -q || echo "::warning::Tests failed or no tests found"

  build_and_push:
    runs-on: ubuntu-latest
    needs: ci
    permissions:
      contents: read
    outputs:
      image_uri: ${{ steps.meta.outputs.image_uri }}
      ecr_registry: ${{ steps.meta.outputs.ecr_registry }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image (sha + latest)
        id: meta
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          IMAGE_URI_LATEST="${ECR_REGISTRY}/${ECR_REPOSITORY}:latest"

          docker build -t "${IMAGE_URI}" -t "${IMAGE_URI_LATEST}" .
          docker push "${IMAGE_URI}"
          docker push "${IMAGE_URI_LATEST}"

          echo "image_uri=${IMAGE_URI}" >> "$GITHUB_OUTPUT"
          echo "ecr_registry=${ECR_REGISTRY}" >> "$GITHUB_OUTPUT"

  deploy_test:
    runs-on: ubuntu-latest
    needs: build_and_push
    permissions:
      contents: read
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get runner public IP
        id: runner_ip
        run: |
          ip=$(curl -s https://checkip.amazonaws.com)
          echo "ip=${ip}" >> "$GITHUB_OUTPUT"

      - name: Authorize runner IP for SSH (JIT)
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id "${{ secrets.AI_TEST_SG_ID }}" \
            --protocol tcp \
            --port 22 \
            --cidr "${{ steps.runner_ip.outputs.ip }}/32" || true

      - name: Deploy to TEST EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AI_TEST_EC2_HOST }}
          username: ${{ secrets.AI_TEST_EC2_USERNAME }}
          key: ${{ secrets.AI_TEST_EC2_SSH_KEY }}
          envs: AWS_REGION
          script: |
            set -euo pipefail

            ECR_REGISTRY="${{ needs.build_and_push.outputs.ecr_registry }}"
            IMAGE_URI="${{ needs.build_and_push.outputs.image_uri }}"

            aws ecr get-login-password --region "${AWS_REGION}" \
              | docker login --username AWS --password-stdin "${ECR_REGISTRY}"

            docker pull "${IMAGE_URI}"

            docker rm -f "${{ env.CONTAINER_NAME }}" || true

            docker run -d \
              --name "${{ env.CONTAINER_NAME }}" \
              -p 8000:8000 \
              --restart unless-stopped \
              --env-file /home/ubuntu/app/ai/.env \
              "${IMAGE_URI}"

            docker image prune -f || true

      - name: Revoke runner IP for SSH (Always)
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id "${{ secrets.AI_TEST_SG_ID }}" \
            --protocol tcp \
            --port 22 \
            --cidr "${{ steps.runner_ip.outputs.ip }}/32" || true
